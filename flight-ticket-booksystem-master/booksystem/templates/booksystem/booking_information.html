{% extends 'booksystem/base.html' %}
{% block content %}
<div class="container" style="margin-top:30px;">
    <div style="background: #f5f7fa; border-radius: 10px; padding: 18px 28px; margin-bottom: 25px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <span style="font-size: 2rem; color: #409eff; margin-right: 15px;">ğŸ“</span>
        <h3 style="margin: 0; font-weight: 600; color: #333; letter-spacing: 2px;">å¡«å†™è´­ç¥¨ä¿¡æ¯</h3>
    </div>
    {% if error_message %}
    <div class="alert alert-danger" role="alert">
        {{ error_message }}
    </div>
    {% endif %}
    <form method="post" id="bookingForm">
        {% csrf_token %}
        <div id="passengersContainer">
            <div class="passenger-form row" style="margin-bottom:10px;">
                <div class="col-md-3">
                    <label>èº«ä»½è¯å·ï¼š</label>
                    <input type="text" name="id_card_1" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <label>å§“åï¼š</label>
                    <input type="text" name="name_1" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label>èˆ±ä½ç­‰çº§ï¼š</label>
                    <select name="cabin_class_1" class="form-control" required>
                        <option value="first">å¤´ç­‰èˆ±</option>
                        <option value="economy">ç»æµèˆ±</option>
                    </select>
                </div>
                <div class="col-md-2" style="margin-top:25px;">
                    <button type="button" class="add-passenger btn btn-success btn-sm" title="æ·»åŠ è´­ç¥¨äºº">æ·»åŠ ä¹˜å®¢</button>
                    <button type="button" class="remove-passenger btn btn-danger btn-sm" title="åˆ é™¤è´­ç¥¨äºº" style="display:none;">ï¼</button>
                </div>
            </div>
        </div>
        <input type="hidden" id="passengerCount" name="passengerCount" value="1">
        <div class="button-group" style="display: flex; gap: 30px; margin-top: 20px;">
            <a href="{% url 'booksystem:result' %}" class="btn btn-outline-primary" style="background-color: #ff9822; color: #fff;">
                è¿”å›
            </a>
            <button type="submit" class="btn btn-primary">ç¡®è®¤</button>
        </div>
    </form>
</div>

<script>
let passengerCount = 1;
const MAX_PASSENGERS = 5;

// æ·»åŠ è´­ç¥¨äºº
document.getElementById('passengersContainer').addEventListener('click', function(e) {
    if (e.target.classList.contains('add-passenger')) {
        if (passengerCount >= MAX_PASSENGERS) {
            alert('æœ€å¤šåªèƒ½æ·»åŠ 5ä½è´­ç¥¨äºº');
            return;
        }
        passengerCount++;
        document.getElementById('passengerCount').value = passengerCount;
        const newDiv = document.createElement('div');
        newDiv.className = 'passenger-form row';
        newDiv.style.marginBottom = '10px';
        newDiv.innerHTML = `
            <div class="col-md-3">
                <label>èº«ä»½è¯å·ï¼š</label>
                <input type="text" name="id_card_${passengerCount}" class="form-control" required>
            </div>
            <div class="col-md-2">
                <label>å§“åï¼š</label>
                <input type="text" name="name_${passengerCount}" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label>èˆ±ä½ç­‰çº§ï¼š</label>
                <select name="cabin_class_${passengerCount}" class="form-control" required>
                    <option value="first">å¤´ç­‰èˆ±</option>
                    <option value="economy">ç»æµèˆ±</option>
                </select>
            </div>
            <div class="col-md-2" style="margin-top:25px;">
                <button type="button" class="add-passenger btn btn-success btn-sm" title="æ·»åŠ è´­ç¥¨äºº">æ·»åŠ ä¹˜å®¢</button>
                <button type="button" class="remove-passenger btn btn-danger btn-sm" title="åˆ é™¤è´­ç¥¨äºº">ï¼</button>
            </div>
        `;
        document.getElementById('passengersContainer').appendChild(newDiv);
        updateRemoveButtons();
    }
    // åˆ é™¤è´­ç¥¨äºº
    if (e.target.classList.contains('remove-passenger')) {
        if (passengerCount <= 1) return;
        e.target.closest('.passenger-form').remove();
        passengerCount--;
        document.getElementById('passengerCount').value = passengerCount;
        // é‡æ–°å‘½åæ‰€æœ‰è´­ç¥¨äººå­—æ®µ
        let forms = document.querySelectorAll('.passenger-form');
        forms.forEach((form, idx) => {
            let i = idx + 1;
            form.querySelector('input[name^="id_card_"]').name = `id_card_${i}`;
            form.querySelector('input[name^="name_"]').name = `name_${i}`;
            form.querySelector('select[name^="cabin_class_"]').name = `cabin_class_${i}`;
        });
        updateRemoveButtons();
    }
});

// ä¿è¯åªæœ‰å¤šäºä¸€è¡Œæ—¶æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
function updateRemoveButtons() {
    let forms = document.querySelectorAll('.passenger-form');
    forms.forEach((form, idx) => {
        let removeBtn = form.querySelector('.remove-passenger');
        if (forms.length > 1) {
            removeBtn.style.display = '';
        } else {
            removeBtn.style.display = 'none';
        }
    });
}
</script>
{% endblock %}